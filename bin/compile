#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

WHITE="\e[97m"
GREEN="\e[32m"
YELLOE="\e[33m"

BUILD_DIR=$1
CACHE_DIR=$2

BIN_PATH="$BUILD_DIR/bin"
TMP_PATH="$BUILD_DIR/tmp"
mkdir -p $CACHE_DIR $BIN_PATH $TMP_PATH

[ -z "$WKHTMLTOPDF_VERSION" ] && WKHTMLTOPDF_VERSION="0.12.4"

BIN_DIR=$(cd $(dirname $0); pwd)
FONTS_DIR=$(cd "$BIN_DIR/../fonts"; pwd)

echo -e "${GREEN}-----> OS${WHITE}"
echo $OSTYPE
echo $(cat /etc/os-release | grep VERSION_CODENAME)

OS_VERSIONCODE=$(cat /etc/os-release | grep VERSION_CODENAME)

if [[ "$OS_VERSIONCODE" == *"VERSION_CODENAME=focal"* ]]; then
    # focal is codename of ubuntu 20
    WKHTMLTOPDF_DEB="wkhtmltox_0.12.5-1.focal_amd64.deb"
elif [[ "$OS_VERSIONCODE" == *"VERSION_CODENAME=xenial"* ]]; then
    # install wkhtmltopdf for ubuntu 16
    WKHTMLTOPDF_DEB="wkhtmltox_0.12.5-1.xenial_amd64.deb"
else
    # default version is for ubuntu 16
    echo -e "${YELLOE}WARNING: ${OS_VERSIONCODE} not supported, install default wkhtmltopdf deb for Ubuntu 16"
    WKHTMLTOPDF_DEB="wkhtmltox_0.12.5-1.xenial_amd64.deb"
fi

WKHTMLTOPDF_URL="https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/${WKHTMLTOPDF_DEB}"

echo -e "${GREEN}-----> Downloading wkhtmltopdf tar${WHITE}"
wget $WKHTMLTOPDF_URL

echo -e "${GREEN}-----> Install wkhtmltopdf${WHITE}"
apt update
apt install xfonts-75dpi xfonts-base
dpkg -i ./$WKHTMLTOPDF_DEB

echo -e "${GREEN}-----> **Test**${WHITE}"
wkhtmltopdf http://google.com google.pdf
rm google.pdf
echo ">> ls -la"
echo $(ls -la)

echo -e "${GREEN}-----> Cleaning up${WHITE}"
rm -rf $WKHTMLTOPDF_DEB

echo -e "${GREEN}-----> Installing fonts${WHITE}"
mkdir -p $1/.fonts
ls $FONTS_DIR
cp $FONTS_DIR/* $1/.fonts/
fc-cache -fv $1/.fonts

exit 0
